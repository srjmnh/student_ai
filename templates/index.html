<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Super Student Management</title>
  
  <!-- Google Font: Roboto -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <style>
    body {
      margin:0; padding:0; background:#f8f9fa;
      font-family: 'Roboto', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background:#1d1d1d; color:#fafafa;
    }
    .chat-wrap {
      max-width:700px; margin:2rem auto; background:#fff; 
      border-radius:0.5rem; box-shadow:0 4px 10px rgba(0,0,0,0.1);
      display:flex; flex-direction:column; height:80vh; overflow:hidden;
      transition: transform 0.5s ease, background 0.3s, color 0.3s;
      font-family: 'Roboto', sans-serif;
    }
    body.dark-mode .chat-wrap {
      background:#333; color:#fff;
    }
    .chat-header {
      background:#343a40; color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center;
    }
    .dark-toggle {
      background:transparent; border:1px solid #fff; color:#fff; 
      border-radius:3px; padding:0.3rem 0.6rem; cursor:pointer;
    }
    .dark-toggle:hover {
      opacity:0.7;
    }
    .chat-body {
      flex:1; padding:1rem; overflow-y:auto; display:flex; flex-direction:column;
    }
    .chat-bubble {
      margin-bottom:0.75rem; padding:0.75rem 1rem; border-radius:15px; 
      max-width:75%; word-wrap:break-word; white-space:pre-wrap;
      transition: background 0.3s ease;
      font-family: 'Roboto', sans-serif;
    }
    .chat-bubble:hover {
      background:#e2e2e2;
    }
    body.dark-mode .chat-bubble:hover {
      background:#444;
    }
    .user-msg {
      background:#007bff; color:#fff; align-self:flex-end; border-bottom-right-radius:0;
    }
    .ai-msg {
      background:#e9ecef; color:#000; align-self:flex-start; border-bottom-left-radius:0;
    }
    body.dark-mode .ai-msg {
      background:#555; color:#fff;
    }
    .chat-footer {
      border-top:1px solid #ddd; padding:1rem; background:#f8f9fa;
      transition: background 0.3s ease;
    }
    body.dark-mode .chat-footer {
      background:#444;
    }
    #tablePanel {
      position:fixed; top:0; right:0; width:50%; height:100%; 
      background:#fff; border-left:1px solid #ccc; padding:1rem; 
      overflow-y:auto; transform:translateX(100%); transition:transform 0.5s ease;
    }
    #tablePanel.show { transform:translateX(0%); }

    #chatSection.slideLeft { transform:translateX(-20%); }

    td[contenteditable="true"] {
      outline:1px dashed #ccc; 
      transition: background 0.3s ease;
    }
    td[contenteditable="true"]:hover {
      background:#fafbcd;
    }

    /* Home Screen Styles */
    #homeScreen {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:#fff; display:flex; flex-direction:column;
      justify-content:center; align-items:center; text-align:center;
      z-index:1000; transition: opacity 0.5s ease, visibility 0.5s ease;
      font-family: 'Roboto', sans-serif;
    }
    body.dark-mode #homeScreen {
      background:#1d1d1d; color:#fafafa;
    }
    #homeScreen.hidden {
      opacity:0; visibility:hidden;
    }
    #homeScreen h1 {
      font-size:2rem; margin-bottom:2rem;
    }
    #homeScreen button {
      padding:0.75rem 1.5rem; font-size:1rem; border:none; border-radius:5px;
      background:#007bff; color:#fff; cursor:pointer;
      transition: background 0.3s ease;
    }
    #homeScreen button:hover {
      background:#0056b3;
    }
    body.dark-mode #homeScreen button {
      background:#28a745;
    }
    body.dark-mode #homeScreen button:hover {
      background:#1e7e34;
    }

    /* Mobile-friendly adjustments */
    @media (max-width:576px) {
      .chat-wrap {
        margin:1rem; height:85vh;
      }
      .chat-bubble {
        max-width:100%;
      }
      #tablePanel {
        width:100%;
      }
      #chatSection.slideLeft {
        transform:translateX(-10%);
      }
    }
  </style>
</head>
<body>
  <!-- Home Screen -->
  <div id="homeScreen">
    <h1>{{ safe_summary }}</h1>
    <button onclick="hideHomeScreen()">Continue</button>
  </div>

  <!-- Background music with random track from an array of URLs -->
  <audio id="bgMusic" autoplay loop></audio>

  <div class="chat-wrap" id="chatSection">
    <div class="chat-header">
      <h4>Student Management Chat</h4>
      <!-- Dark Mode Toggle Button -->
      <button class="dark-toggle" onclick="toggleDarkMode()">🌙 Dark Mode</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-footer">
      <div class="input-group">
        <input type="text" class="form-control" id="userInput" placeholder="Ask me anything..."
               onkeydown="if(event.key==='Enter') sendPrompt();">
        <button class="btn btn-primary" onclick="sendPrompt()">Send</button>
      </div>
    </div>
  </div>

  <div id="tablePanel"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Array of random music URLs
    const musicTracks = [
      "https://www.bensound.com/bensound-music/bensound-anewbeginning.mp3",
      "https://www.bensound.com/bensound-music/bensound-ukulele.mp3",
      "https://www.bensound.com/bensound-music/bensound-funnysong.mp3"
    ];

    window.addEventListener('DOMContentLoaded', () => {
      const bgMusic = document.getElementById('bgMusic');
      const randomUrl = musicTracks[Math.floor(Math.random() * musicTracks.length)];
      bgMusic.src = randomUrl;

      // Home Screen is already displaying the summary
    });

    const chatBody = document.getElementById('chatBody');
    const userInput = document.getElementById('userInput');
    const chatSection = document.getElementById('chatSection');
    const tablePanel = document.getElementById('tablePanel');
    const homeScreen = document.getElementById('homeScreen');

    function addBubble(text, isUser=false) {
      const bubble = document.createElement('div');
      bubble.classList.add('chat-bubble', isUser ? 'user-msg' : 'ai-msg');
      bubble.innerHTML = text;
      chatBody.appendChild(bubble);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function sendPrompt() {
      const prompt = userInput.value.trim();
      if(!prompt) return;
      addBubble(prompt, true);
      userInput.value = '';

      try {
        const resp = await fetch('/process_prompt', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ prompt })
        });
        const data = await resp.json();
        const reply = data.message || data.error || 'No response.';
        parseReply(reply);
      } catch(err) {
        addBubble("Error connecting to server: "+err, false);
      }
    }

    function parseReply(reply) {
      // If reply includes <table or 'slideFromRight', we show in tablePanel
      if(reply.includes('<table') || reply.includes('slideFromRight')) {
        tablePanel.innerHTML = reply;
        tablePanel.classList.add('show');
        chatSection.classList.add('slideLeft');
      } else {
        addBubble(reply, false);
      }
    }

    async function saveTableEdits() {
      const rows = tablePanel.querySelectorAll('table tbody tr');
      const updates = [];
      rows.forEach(r => {
        const cells = r.querySelectorAll('td');
        if(!cells.length) return;
        const sid = cells[0].innerText.trim();
        if(!sid) return;

        let name = cells[1].innerText.trim();
        let age = cells[2].innerText.trim();
        let sclass = cells[3].innerText.trim();
        let address = cells[4].innerText.trim();
        let phone = cells[5].innerText.trim();
        let guardian = cells[6].innerText.trim();
        let guardianPhone = cells[7].innerText.trim();
        let attendance = cells[8].innerText.trim();
        let grades = cells[9].innerText.trim();
        try {
          grades = JSON.parse(grades);
        } catch(e){}

        updates.push({
          id: sid,
          name,
          age,
          class: sclass,
          address,
          phone,
          guardian_name: guardian,
          guardian_phone: guardianPhone,
          attendance,
          grades
        });
      });

      try {
        const res = await fetch('/bulk_update_students', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ updates })
        });
        const data = await res.json();
        if(data.success) {
          addBubble("Changes saved to Firebase!", false);
        } else {
          addBubble("Error saving changes: "+(data.error||'unknown'), false);
        }
      } catch(err) {
        addBubble("Error saving changes: "+err, false);
      }
      tablePanel.classList.remove('show');
      chatSection.classList.remove('slideLeft');
    }

    // Dark Mode Toggle Function
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const toggleBtn = document.querySelector('.dark-toggle');
      if(document.body.classList.contains('dark-mode')) {
        toggleBtn.textContent = '☀️ Light Mode';
        localStorage.setItem('dark-mode', 'enabled');
      } else {
        toggleBtn.textContent = '🌙 Dark Mode';
        localStorage.setItem('dark-mode', 'disabled');
      }
    }

    // Initialize the toggle button text based on saved preference
    window.addEventListener('load', () => {
      const toggleBtn = document.querySelector('.dark-toggle');
      // Check if dark mode was previously enabled
      const darkMode = localStorage.getItem('dark-mode');
      if(darkMode === 'enabled') {
        document.body.classList.add('dark-mode');
        toggleBtn.textContent = '☀️ Light Mode';
      } else {
        toggleBtn.textContent = '🌙 Dark Mode';
      }
    });

    // Home Screen Functionality
    function hideHomeScreen() {
      homeScreen.classList.add('hidden');
      // After transition, hide the home screen completely
      setTimeout(() => {
        homeScreen.style.display = 'none';
      }, 500);
    }
  </script>
</body>
</html>
