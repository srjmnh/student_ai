{% extends "base.html" %}

{% block title %}Employee Dashboard{% endblock %}

{% block content %}
<h2 class="mt-4">Employee Dashboard</h2>

<!-- Personal Information -->
<div class="card mb-3">
    <div class="card-header">
        Personal Information
    </div>
    <div class="card-body">
        <p><strong>Name:</strong> <span id="empName"></span></p>
        <p><strong>Position:</strong> <span id="empPosition"></span></p>
        <p><strong>Department:</strong> <span id="empDepartment"></span></p>
        <p><strong>Email:</strong> <span id="empEmail"></span></p>
        <p><strong>Phone:</strong> <span id="empPhone"></span></p>
    </div>
</div>

<!-- Leave Requests -->
<h4>Leave Requests</h4>
<button class="btn btn-primary mb-3" onclick="showSubmitLeaveForm()">Submit Leave Request</button>

<!-- Submit Leave Form Modal -->
<div class="modal fade" id="submitLeaveModal" tabindex="-1" aria-labelledby="submitLeaveModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="submitLeaveForm">
        <div class="modal-header">
          <h5 class="modal-title" id="submitLeaveModalLabel">Submit Leave Request</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="start_date" class="form-label">Start Date:</label>
                <input type="date" class="form-control" id="start_date" required>
            </div>
            <div class="mb-3">
                <label for="end_date" class="form-label">End Date:</label>
                <input type="date" class="form-control" id="end_date" required>
            </div>
            <div class="mb-3">
                <label for="reason" class="form-label">Reason:</label>
                <textarea class="form-control" id="reason" rows="3" required></textarea>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Submit Leave</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Leave Requests Table -->
<table class="table table-bordered" id="leaveRequestsTable">
    <thead>
        <tr>
            <th>Leave ID</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Leave Requests Will Be Injected Here -->
    </tbody>
</table>

<script>
    // Function to Show Submit Leave Modal
    function showSubmitLeaveForm() {
        var submitLeaveModal = new bootstrap.Modal(document.getElementById('submitLeaveModal'));
        submitLeaveModal.show();
    }

    // Function to Fetch and Display Employee Details and Leave Requests
    async function fetchEmployeeDashboard() {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/employee/dashboard', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.status === 200) {
                populateEmployeeInfo(data.employee);
                populateLeaveRequestsTable(data.leave_requests);
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching dashboard:', error);
            alert('An error occurred while fetching the dashboard.');
        }
    }

    // Function to Populate Employee Information
    function populateEmployeeInfo(employee) {
        document.getElementById('empName').innerText = employee.name;
        document.getElementById('empPosition').innerText = employee.position;
        document.getElementById('empDepartment').innerText = employee.department;
        document.getElementById('empEmail').innerText = employee.email;
        document.getElementById('empPhone').innerText = employee.phone;
    }

    // Function to Populate Leave Requests Table
    function populateLeaveRequestsTable(leaves) {
        const tableBody = document.querySelector('#leaveRequestsTable tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        leaves.forEach(leave => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${leave.leave_id}</td>
                <td>${leave.start_date}</td>
                <td>${leave.end_date}</td>
                <td>${leave.reason}</td>
                <td>${leave.status}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewLeave('${leave.leave_id}')">View</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Function to Handle Submit Leave Form Submission
    document.getElementById('submitLeaveForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const start_date = document.getElementById('start_date').value;
        const end_date = document.getElementById('end_date').value;
        const reason = document.getElementById('reason').value.trim();

        const token = localStorage.getItem('token');

        try {
            const response = await fetch('/employee/submit_leave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    start_date,
                    end_date,
                    reason
                })
            });
            const data = await response.json();
            if (response.status === 201) {
                alert(data.message);
                var submitLeaveModal = bootstrap.Modal.getInstance(document.getElementById('submitLeaveModal'));
                submitLeaveModal.hide();
                fetchEmployeeDashboard();
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error submitting leave:', error);
            alert('An error occurred while submitting the leave request.');
        }
    });

    // Function to View Leave Request Details
    async function viewLeave(leave_id) {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/employee/get_leave/${leave_id}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.status === 200) {
                // Display leave details (Enhance as needed, e.g., using a modal)
                alert(`Leave Details:\nStart Date: ${data.leave.start_date}\nEnd Date: ${data.leave.end_date}\nReason: ${data.leave.reason}\nStatus: ${data.leave.status}`);
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error viewing leave:', error);
            alert('An error occurred while viewing the leave request.');
        }
    }

    // Initial Fetch of Dashboard Data
    fetchEmployeeDashboard();
</script>
{% endblock %}
