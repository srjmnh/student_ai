{% extends "base.html" %}

{% block title %}HR Dashboard{% endblock %}

{% block content %}
<h2 class="mt-4">HR Dashboard</h2>
<button class="btn btn-success mb-3" onclick="showAddEmployeeForm()">Add New Employee</button>

<!-- Add Employee Form Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addEmployeeForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addEmployeeModalLabel">Add New Employee</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="emp_id" class="form-label">Employee ID:</label>
                <input type="text" class="form-control" id="emp_id" required>
            </div>
            <div class="mb-3">
                <label for="name" class="form-label">Name:</label>
                <input type="text" class="form-control" id="name" required>
            </div>
            <div class="mb-3">
                <label for="position" class="form-label">Position:</label>
                <input type="text" class="form-control" id="position" required>
            </div>
            <div class="mb-3">
                <label for="department" class="form-label">Department:</label>
                <input type="text" class="form-control" id="department" required>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email:</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone:</label>
                <input type="text" class="form-control" id="phone" required>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add Employee</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Employees Table -->
<table class="table table-striped" id="employeesTable">
    <thead>
        <tr>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Position</th>
            <th>Department</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Employee Rows Will Be Injected Here -->
    </tbody>
</table>

<script>
    // Function to Show Add Employee Modal
    function showAddEmployeeForm() {
        var addEmployeeModal = new bootstrap.Modal(document.getElementById('addEmployeeModal'));
        addEmployeeModal.show();
    }

    // Function to Fetch and Display Employees
    async function fetchEmployees() {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/hr/dashboard', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.status === 200) {
                populateEmployeesTable(data.employees);
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching employees:', error);
            alert('An error occurred while fetching employees.');
        }
    }

    // Function to Populate Employees Table
    function populateEmployeesTable(employees) {
        const tableBody = document.querySelector('#employeesTable tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        employees.forEach(emp => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${emp.emp_id}</td>
                <td>${emp.name}</td>
                <td>${emp.position}</td>
                <td>${emp.department}</td>
                <td>${emp.email}</td>
                <td>${emp.phone}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewEmployee('${emp.emp_id}')">View</button>
                    <button class="btn btn-warning btn-sm" onclick="editEmployee('${emp.emp_id}')">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEmployee('${emp.emp_id}')">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Function to Handle Add Employee Form Submission
    document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const emp_id = document.getElementById('emp_id').value.trim();
        const name = document.getElementById('name').value.trim();
        const position = document.getElementById('position').value.trim();
        const department = document.getElementById('department').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();

        const token = localStorage.getItem('token');

        try {
            const response = await fetch('/hr/add_employee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    emp_id,
                    name,
                    position,
                    department,
                    email,
                    phone
                })
            });
            const data = await response.json();
            if (response.status === 201) {
                alert(data.message);
                var addEmployeeModal = bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal'));
                addEmployeeModal.hide();
                fetchEmployees();
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error adding employee:', error);
            alert('An error occurred while adding the employee.');
        }
    });

    // Function to View Employee Details
    async function viewEmployee(emp_id) {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/hr/view_employee/${emp_id}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.status === 200) {
                // Display employee details (You can enhance this as needed)
                alert(`Employee Details:\nName: ${data.employee.name}\nPosition: ${data.employee.position}\nDepartment: ${data.employee.department}\nEmail: ${data.employee.email}\nPhone: ${data.employee.phone}`);
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error viewing employee:', error);
            alert('An error occurred while viewing the employee.');
        }
    }

    // Function to Edit Employee Details
    async function editEmployee(emp_id) {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/hr/view_employee/${emp_id}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.status === 200) {
                // Pre-fill edit form (You can create a modal similar to add employee)
                const newName = prompt("Enter new name:", data.employee.name);
                const newPosition = prompt("Enter new position:", data.employee.position);
                const newDepartment = prompt("Enter new department:", data.employee.department);
                const newEmail = prompt("Enter new email:", data.employee.email);
                const newPhone = prompt("Enter new phone:", data.employee.phone);
                
                if (newName && newPosition && newDepartment && newEmail && newPhone) {
                    const updateResponse = await fetch(`/hr/edit_employee/${emp_id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            name: newName,
                            position: newPosition,
                            department: newDepartment,
                            email: newEmail,
                            phone: newPhone
                        })
                    });
                    const updateData = await updateResponse.json();
                    if (updateResponse.status === 200) {
                        alert(updateData.message);
                        fetchEmployees();
                    } else {
                        alert(`Error: ${updateData.error}`);
                    }
                } else {
                    alert('All fields are required to update.');
                }
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error editing employee:', error);
            alert('An error occurred while editing the employee.');
        }
    }

    // Function to Delete Employee
    async function deleteEmployee(emp_id) {
        if (!confirm(`Are you sure you want to delete employee ID: ${emp_id}?`)) {
            return;
        }
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/hr/delete_employee/${emp_id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            if (response.status === 200) {
                alert(data.message);
                fetchEmployees();
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error deleting employee:', error);
            alert('An error occurred while deleting the employee.');
        }
    }

    // Initial Fetch of Employees
    fetchEmployees();
</script>
<!-- Chatbot Interface -->
<div class="mt-5">
    <h4>Support Chatbot</h4>
    <div class="card">
        <div class="card-body" id="chatBox" style="height: 300px; overflow-y: scroll;">
            <!-- Chat messages will appear here -->
        </div>
        <div class="card-footer">
            <form id="chatForm">
                <div class="input-group">
                    <input type="text" class="form-control" id="chatInput" placeholder="Type your message..." required>
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Function to Send Chat Message
    async function sendChatMessage() {
        const message = document.getElementById('chatInput').value.trim();
        if (!message) return;

        // Display user's message
        appendChatMessage(message, 'user');

        // Clear input field
        document.getElementById('chatInput').value = '';

        const token = localStorage.getItem('token');

        try {
            const response = await fetch('/ai/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ message })
            });
            const data = await response.json();
            if (response.status === 200) {
                appendChatMessage(data.response, 'bot');
            } else {
                appendChatMessage(data.error || "I'm sorry, I couldn't process your request.", 'bot');
            }
        } catch (error) {
            appendChatMessage('Error connecting to AI service.', 'bot');
            console.error('Error:', error);
        }
    }

    // Function to Append Chat Message to Chat Box
    function appendChatMessage(message, sender) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('mb-2', sender === 'bot' ? 'text-start' : 'text-end');
        messageDiv.innerHTML = `<strong>${sender === 'bot' ? 'Bot' : 'You'}:</strong> ${message}`;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Event Listener for Chat Form Submission
    document.getElementById('chatForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendChatMessage();
    });
</script>
